# TODO

## 改善タスク一覧

- [ ] **認証・認可機能の追加**
  - JWTなどを用いて、APIエンドポイントへのアクセスを保護する認証・認可のミドルウェアを導入する。
  - [x] **ステップ1: ユーザー管理のためのデータベース準備**
    - [x] `users`テーブルのマイグレーションファイル作成
    - [x] `users`テーブル用のSQLクエリ作成 (`sqlc`)
  - [x] **ステップ2: 依存ライブラリの追加**
    - [x] JWTライブラリの追加 (`go get github.com/golang-jwt/jwt/v5`)
  - [x] **ステップ3: ドメインとユースケースの作成**
    - [x] `user`ドメインの定義
    - [x] `UserRepository`のインフラ層実装 (`internal/infrastructure/postgres/user_postgres.go`)
    - [x] モックの再生成 (`go generate ./...`)
    - [x] `auth`ユースケースの作成 (ユーザー登録・ログイン処理)
      - [x] 入出力の定義 (`internal/usecase/output/auth.go`)
      - [x] JWTトークンの生成と返却 (`internal/usecase/auth.go`)
      - [x] テストの作成 (`internal/usecase/auth_test.go`)
  - [x] **ステップ4: 設定の追加**
    - [x] JWT秘密鍵を環境変数に追加 (`.env`と`config.go`)
  - [ ] **ステップ5: インターフェース層の実装**
    - [x] `auth`ハンドラの作成 (`/register`, `/login`)
    - [x] 認証ミドルウェアの作成
  - [ ] **ステップ7: 認証ミドルウェアの改善**
    - [x] トークンの失効メカニズムの導入
      - [x] `revoked_tokens`テーブルのマイグレーションファイル作成
      - [x] `revoked_tokens`テーブルのSQLクエリ作成 (`sqlc`)
      - [x] `RevokedToken`ドメインの定義
      - [x] `RevokedTokenRepository`のインフラ層実装 (`internal/infrastructure/postgres/revoked_token_postgres.go`)
      - [x] `RevokedTokenRepository`のテスト作成 (`internal/infrastructure/postgres/revoked_token_postgres_test.go`)
        - [x] `Create`メソッドの異常系テスト（重複するJTI）
    - [ ] リフレッシュトークンの導入
      - [x] `LoginOutput`に`RefreshToken`フィールドを追加
      - [x] `auth`ユースケースでリフレッシュトークンを生成
      - [x] リフレッシュトークンをデータベースで管理するためのテーブル設計と実装
      - [x] リフレッシュトークンの検証と失効ロジックの実装
      - [x] アクセストークンをリフレッシュするAPIエンドポイントの作成
    - [ ] テスト容易性の向上 (DIの徹底)
    - [ ] レートリミット/ブルートフォース対策の導入
- [ ] **トランザクション管理の導入**
  - 複数のDB操作が絡むユースケース（例: ログイン時のトークン保存）において、データの一貫性を保証するためのトランザクション管理を導入する。
  - ユースケース層にトランザクションマネージャーを注入し、アトミックな操作を可能にする。
  - [x] **ステップ6: ルーティングの更新**
    - [x] `main.go`で認証ミドルウェアを適用

## ドキュメント更新

- [ ] `docs/cmd.md`のコード例を`cmd/server/main.go`の現在の実装に合わせて更新する。
- [ ] `docs/injector.md`のコード例に`NewAuthHandler`の記述を追加する。
- [ ] `docs/config.md`のコード例に`JWTSecret()`関数の記述を追加する。

## 実運用における改善点

- [ ] **認証・認可機能の改善**
  - [ ] リフレッシュトークンローテーションにおけるエラーハンドリングの強化: 古いトークンの削除失敗時のリカバリ戦略を検討する。
  - [ ] リフレッシュトークンの再利用攻撃に対するより厳密な対策を検討する（例: リフレッシュトークンファミリーの管理、使用済みトークンの即時失効など）。
  - [ ] JWT秘密鍵のよりセキュアな管理方法を検討する（例: シークレット管理サービスとの連携）。
- [ ] **エラーハンドリングの改善**
  - [ ] `internal/config/config.go`の`JWTSecret()`でJWT秘密鍵が未設定の場合のエラーコードを`InternalServerError`ではなく、より具体的な`ConfigurationError`のようなものに改善する。
  - [ ] `_ =`でエラーを無視している箇所（特に`pgtype.UUID.Scan`など）について、エラーハンドリングの必要性を再検討するか、意図をコメントで明記する。
- [ ] **トランザクション管理の導入** (既存の項目をより具体的に)
  - [ ] 複数のDB操作が絡むユースケース（例: ログイン時のトークン保存と削除、リフレッシュトークンローテーション）において、データの一貫性を保証するためのトランザクション管理を導入する。
  - [ ] ユースケース層にトランザクションマネージャーを注入し、アトミックな操作を可能にする。